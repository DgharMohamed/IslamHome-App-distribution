# خطة التنفيذ: إصلاح مشغل القرآن في الإشعارات

## نظرة عامة

تحويل تصميم الميزة إلى سلسلة من المهام لتنفيذ إصلاح وتحسين مشغل القرآن في الإشعارات. كل مهمة تبني على المهام السابقة وتنتهي بربط جميع المكونات معاً.

## المهام

- [x] 1. إعداد البنية الأساسية وإعادة تكوين AudioService
  - إنشاء QuranAudioHandler الجديد مع التكوين الصحيح
  - تحديث تكوين AudioService للإشعارات العربية
  - إعداد NotificationManager مع القناة المخصصة
  - _المتطلبات: 1.1، 5.1_

- [x] 1.1 كتابة اختبار خاصية لتكوين AudioService

  - **الخاصية 7: استعادة الجلسة عند بدء التطبيق**
  - **تتحقق من: المتطلبات 5.4**

- [ ] 2. تنفيذ نماذج البيانات الأساسية
  - [x] 2.1 إنشاء QuranVerse وQuranMediaItem
    - تنفيذ تحويل QuranVerse إلى MediaItem
    - إضافة دعم للمعلومات العربية (اسم السورة، رقم الآية)
    - _المتطلبات: 3.1، 3.2_
  
  - [ ] 2.2 كتابة اختبار خاصية لنماذج البيانات

    - **الخاصية 1: عرض معلومات الإشعار الصحيحة**
    - **تتحقق من: المتطلبات 1.1، 3.1، 3.2**
  
  - [x] 2.3 تنفيذ PlaybackSession لحفظ واستعادة الحالة
    - إضافة آليات التسلسل والإلغاء
    - دعم حفظ الموضع الحالي والقائمة
    - _المتطلبات: 5.4_

- [ ] 3. تنفيذ QuranAudioHandler الأساسي
  - [x] 3.1 تنفيذ العمليات الأساسية (play, pause, stop)
    - ربط العمليات مع just_audio player
    - إضافة بث حالة التشغيل الصحيحة
    - _المتطلبات: 2.1، 5.1_
  
  - [ ]* 3.2 كتابة اختبار خاصية للعمليات الأساسية
    - **الخاصية 3: استجابة أزرار التحكم في الإشعار**
    - **تتحقق من: المتطلبات 2.1، 2.2، 2.3**
  
  - [x] 3.3 تنفيذ عمليات التنقل (skipToNext, skipToPrevious)
    - إضافة منطق التنقل بين الآيات
    - تحديث MediaItem عند التنقل
    - _المتطلبات: 2.2، 2.3_
  
  - [ ] 3.4 كتابة اختبارات وحدة للتنقل

    - اختبار حالات الحافة (الآية الأولى والأخيرة)
    - اختبار التنقل في قوائم مختلفة الأحجام
    - _المتطلبات: 2.2، 2.3_

- [x] 4. نقطة تفتيش - التأكد من نجاح جميع الاختبارات
  - التأكد من نجاح جميع الاختبارات، اسأل المستخدم إذا كانت هناك أسئلة.

- [ ] 5. تنفيذ إدارة الإشعارات المحسنة
  - [x] 5.1 تحديث NotificationManager لدعم النصوص العربية
    - إضافة دعم للخطوط العربية في الإشعارات
    - تحسين تخطيط الإشعار لعرض معلومات القرآن
    - _المتطلبات: 1.1، 3.1، 3.2_
  
  - [x] 5.2 تنفيذ تحديث الإشعار الفوري
    - إضافة آلية تحديث الإشعار عند تغيير المحتوى
    - ضمان التحديث خلال ثانية واحدة
    - _المتطلبات: 1.4، 3.3_
  
  - [ ] 5.3 كتابة اختبار خاصية لتحديث الإشعار

    - **الخاصية 2: تحديث الإشعار عند تغيير المحتوى**
    - **تتحقق من: المتطلبات 1.4، 3.3**

- [ ] 6. تنفيذ مزامنة الحالة بين المكونات
  - [x] 6.1 إنشاء StateManager لمزامنة الحالة
    - ربط AudioHandler مع واجهة المستخدم
    - ضمان انتشار التغييرات من الإشعار للواجهة
    - _المتطلبات: 2.4، 5.1، 5.2_
  
  - [ ] 6.2 كتابة اختبار خاصية لمزامنة الحالة

    - **الخاصية 4: مزامنة الحالة بين المكونات**
    - **تتحقق من: المتطلبات 2.4، 4.4، 5.1، 5.2**
  
  - [ ] 6.3 تنفيذ آلية استعادة الحالة عند العودة للتطبيق
    - حفظ الحالة عند الانتقال للخلفية
    - استعادة الحالة عند العودة للمقدمة
    - _المتطلبات: 4.4، 5.4_

- [ ] 7. تنفيذ دعم التشغيل في الخلفية
  - [ ] 7.1 تحسين تكوين AudioService للخلفية
    - ضمان استمرار التشغيل عند الانتقال للخلفية
    - تفعيل الاستجابة لأوامر الإشعار في الخلفية
    - _المتطلبات: 1.2، 4.1، 4.2_
  
  - [ ] 7.2 كتابة اختبار خاصية للتشغيل في الخلفية

    - **الخاصية 5: استمرار التشغيل في الخلفية**
    - **تتحقق من: المتطلبات 1.2، 4.1، 4.2**
  
  - [ ] 7.3 تنفيذ تنظيف الموارد عند الإنهاء
    - إضافة آلية تنظيف عند إغلاق التطبيق
    - إزالة الإشعارات وإيقاف الخدمات
    - _المتطلبات: 1.3، 4.3_
  
  - [ ] 7.4 كتابة اختبار خاصية لتنظيف الموارد

    - **الخاصية 6: تنظيف الموارد عند الإنهاء**
    - **تتحقق من: المتطلبات 1.3، 4.3**

- [ ] 8. تنفيذ معالجة الأخطاء الشاملة
  - [ ] 8.1 إنشاء ErrorHandler لمعالجة أخطاء الشبكة والملفات
    - معالجة انقطاع الاتصال أثناء التشغيل
    - معالجة الملفات الصوتية المفقودة أو التالفة
    - _المتطلبات: 6.1، 6.2_
  
  - [ ] 8.2 تنفيذ معالجة أخطاء الخدمة والنظام
    - إعادة تهيئة AudioService عند الفشل
    - معالجة فشل الإشعارات مع استمرار التشغيل
    - _المتطلبات: 6.3، 6.4_
  
  - [ ] 8.3 كتابة اختبار خاصية لمعالجة الأخطاء

    - **الخاصية 8: معالجة الأخطاء بأمان**
    - **تتحقق من: المتطلبات 2.5، 5.3، 6.1، 6.2، 6.3، 6.4**
  
  - [ ] 8.4 كتابة اختبارات وحدة لسيناريوهات الأخطاء المختلفة

    - اختبار انقطاع الشبكة أثناء التشغيل
    - اختبار ملفات صوتية تالفة
    - اختبار فشل خدمة الإشعارات
    - _المتطلبات: 6.1، 6.2، 6.3، 6.4_

- [ ] 9. نقطة تفتيش - التأكد من نجاح جميع الاختبارات
  - التأكد من نجاح جميع الاختبارات، اسأل المستخدم إذا كانت هناك أسئلة.

- [ ] 10. التكامل والربط النهائي
  - [ ] 10.1 ربط جميع المكونات في QuranPlaybackService
    - تهيئة AudioService مع التكوين الكامل
    - ربط ErrorHandler مع AudioHandler
    - تفعيل StateManager للمزامنة
    - _المتطلبات: جميع المتطلبات_
  
  - [ ] 10.2 تحديث واجهة المستخدم الحالية للتكامل
    - استبدال الكود القديم بـ QuranPlaybackService الجديد
    - تحديث أزرار التحكم للاستخدام الجديد
    - _المتطلبات: 2.4، 5.2_
  
  - [ ] 10.3 كتابة اختبارات تكامل شاملة

    - اختبار التدفق الكامل من بدء التشغيل حتى الإنهاء
    - اختبار التكامل بين الواجهة والإشعارات
    - _المتطلبات: جميع المتطلبات_

- [ ] 11. نقطة تفتيش نهائية - التأكد من نجاح جميع الاختبارات
  - التأكد من نجاح جميع الاختبارات، اسأل المستخدم إذا كانت هناك أسئلة.

## ملاحظات

- المهام المميزة بـ `*` اختيارية ويمكن تخطيها للحصول على MVP أسرع
- كل مهمة تشير إلى متطلبات محددة لضمان التتبع
- نقاط التفتيش تضمن التحقق التدريجي
- اختبارات الخصائص تتحقق من خصائص الصحة العامة
- اختبارات الوحدة تتحقق من أمثلة محددة وحالات الحافة